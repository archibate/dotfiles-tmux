# ============================================================================
# tmux-i3-workflow - i3wm-style tmux configuration
# Version: 1.0.0
# ============================================================================
# This configuration brings i3wm-style workflow to tmux, designed for i3wm
# users who want consistent keybindings across GUI and terminal.
# ============================================================================

# ----------------------------------------------------------------------------
# Core Settings (NFR-1, FR-17, FR-18, FR-19, NFR-7)
# ----------------------------------------------------------------------------

# Zero escape delay - critical for vim users (NFR-1)
set -s escape-time 0

# Windows and panes start at index 1 (FR-17, FR-18)
set -g base-index 1
setw -g pane-base-index 1

# Auto-renumber windows when one is closed (FR-19)
set -g renumber-windows on

# Enable mouse support for pane selection and resizing (NFR-7)
set -g mouse on

# Use vi mode for copy mode
setw -g mode-keys vi

# Enable extended keys for better modifier support
set -s extended-keys on

# Terminal color support - 256 colors + true color (NFR-4)
set -g default-terminal "screen-256color"
set -ga terminal-overrides ",*256col*:Tc"

# Increase history limit
set -g history-limit 50000

# Refresh status bar every 15 seconds (NFR-3)
set -g status-interval 15

# Enable focus events for vim autoread
set -g focus-events on

# Aggressive resize for shared sessions
setw -g aggressive-resize on

# ----------------------------------------------------------------------------
# Clipboard Integration - OSC 52 (FR-22, FR-23, FR-24)
# ----------------------------------------------------------------------------
# OSC 52 is a terminal escape sequence that enables clipboard access.
# Works in Kitty, Alacritty, iTerm2, Foot, and other modern terminals.

# Enable OSC 52 clipboard
set -g set-clipboard on

# Allow passthrough for SSH sessions (FR-24)
set -g allow-passthrough on

# Vi-mode copy using OSC 52 (FR-22)
# The empty string tells tmux to use OSC 52
bind -T copy-mode-vi y send -X copy-pipe-and-cancel ""
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel ""
bind -T copy-mode-vi Enter send -X copy-pipe-and-cancel ""

# Paste from system clipboard - Alt+p (FR-23)
bind -n M-p paste-buffer

# ----------------------------------------------------------------------------
# Plugin Manager (TPM)
# ----------------------------------------------------------------------------
# List of plugins to install with TPM

# TPM - Tmux Plugin Manager
set -g @plugin 'tmux-plugins/tpm'

# Sensible defaults - base settings that everyone can agree on
set -g @plugin 'tmux-plugins/tmux-sensible'

# tmux-tilish - i3wm-style keybindings
set -g @plugin 'jabirali/tmux-tilish'

# tmux-sessionx - Fuzzy session management
set -g @plugin 'omerxx/tmux-sessionx'

# Catppuccin theme - beautiful colors (NFR-9)
set -g @plugin 'catppuccin/tmux'

# tmux-resurrect - Session persistence (FR-15)
set -g @plugin 'tmux-plugins/tmux-resurrect'

# tmux-continuum - Auto-save sessions (FR-16)
set -g @plugin 'tmux-plugins/tmux-continuum'

# ----------------------------------------------------------------------------
# Plugin Configuration: tmux-tilish
# ----------------------------------------------------------------------------
# i3wm-style keybindings - no prefix mode

# Use Alt as modifier (like i3wm's $mod)
set -g @tilish-default "main-vertical"  # FR-20: Default layout

# Don't use prefix mode - direct Alt bindings
set -g @tilish-noprefix "on"

# ----------------------------------------------------------------------------
# Plugin Configuration: tmux-sessionx
# ----------------------------------------------------------------------------
# Fuzzy session switcher

# Sessionx configuration for popup usage
set -g @sessionx-window-mode "on"
set -g @sessionx-preview-enabled "true"
set -g @sessionx-auto-accept "off"

# ----------------------------------------------------------------------------
# Plugin Configuration: catppuccin (NFR-8, NFR-9)
# ----------------------------------------------------------------------------
# Minimal Catppuccin Mocha theme

set -g @catppuccin_flavor "mocha"
set -g @catppuccin_window_status_style "rounded"

# Status bar configuration
set -g @catppuccin_status_left_separator ""
set -g @catppuccin_status_right_separator " "
set -g @catppuccin_status_fill "icon"
set -g @catppuccin_status_connect_separator "no"

# Window format
set -g @catppuccin_window_default_fill "number"
set -g @catppuccin_window_default_text "#W"
set -g @catppuccin_window_current_fill "number"
set -g @catppuccin_window_current_text "#W"

# Status modules
set -g @catppuccin_status_modules_right "session"

# ----------------------------------------------------------------------------
# Plugin Configuration: tmux-resurrect (FR-15)
# ----------------------------------------------------------------------------
# Session persistence and restoration

# Restore sessions on tmux start
set -g @resurrect-capture-pane-contents "on"
set -g @resurrect-strategy-nvim "session"

# Programs to restore
set -g @resurrect-processes 'vim nvim emacs man less tail git'

# ----------------------------------------------------------------------------
# Plugin Configuration: tmux-continuum (FR-16)
# ----------------------------------------------------------------------------
# Auto-save sessions every 15 minutes

set -g @continuum-restore "on"
set -g @continuum-save-interval "15"

# ----------------------------------------------------------------------------
# Status Bar Configuration (NFR-8)
# ----------------------------------------------------------------------------
# Minimal status bar: Session | Windows | Time

# Status bar position
set -g status-position bottom

# Status bar length
set -g status-left-length 30
set -g status-right-length 50

# Left: session name
set -g status-left ""

# Center: window list
set -g status-justify centre

# Right: time
set -g status-right "%H:%M"

# Enable window activity monitoring
set -g monitor-activity on
setw -g monitor-activity on

# ----------------------------------------------------------------------------
# Custom Keybindings (FR-10 - Resize Mode)
# ----------------------------------------------------------------------------
# Additional bindings that supplement tmux-tilish

# Resize mode - Alt+r (FR-10)
bind -n M-r switch-client -T resize

# Resize mode key bindings
bind -T resize h resize-pane -L 5
bind -T resize j resize-pane -D 5
bind -T resize k resize-pane -U 5
bind -T resize l resize-pane -R 5
bind -T resize H resize-pane -L 10
bind -T resize J resize-pane -D 10
bind -T resize K resize-pane -U 10
bind -T resize L resize-pane -R 10
bind -T resize Escape switch-client -T root
bind -T resize Enter switch-client -T root

# Window switching with Alt+0-9 (supplemental - tilish handles 1-9)
# Note: tmux-tilish handles Alt+1 to Alt+9, we add Alt+0 for window 10
bind -n M-0 select-window -t 0

# Move pane to window with Alt+Shift+0-9 (FR-2)
# Note: tmux-tilish handles Alt+Shift+1 to Alt+Shift+9
# Move pane to window 10 (Alt+0 switches to window 10)
bind -n M-S-0 join-pane -t :10

# ----------------------------------------------------------------------------
# Popup Bindings (FR-25, FR-26)
# ----------------------------------------------------------------------------
# Centered popups for session switcher and zoxide

# Session switcher popup - Alt+d (FR-11, FR-25)
bind -n M-d display-popup -E -w 80% -h 60% "tmux-sessionx"

# Zoxide directory picker popup - Alt+o (FR-13, FR-26)
bind -n M-o display-popup -E -w 80% -h 60% "~/.config/tmux/scripts/zoxide-jump.sh"

# Copy mode - Alt+[
bind -n M-[ copy-mode

# ----------------------------------------------------------------------------
# Split Keybindings (FR-5, FR-6, FR-7)
# ----------------------------------------------------------------------------
# These supplement tmux-tilish bindings

# Create new pane with Alt+Enter (FR-5)
# Note: tmux-tilish handles this, but we provide fallback
bind -n M-Enter split-window -v -c "#{pane_current_path}"

# Alt+s for main-horizontal layout (FR-6)
bind -n M-s select-layout main-horizontal

# Alt+v for main-vertical layout (FR-7)
bind -n M-v select-layout main-vertical

# Alt+z for zoom (FR-8)
bind -n M-z resize-pane -Z

# Kill pane with confirmation - Alt+Shift+q (FR-9)
bind -n M-S-q confirm-before -p "Kill pane #P? (y/n)" kill-pane

# ----------------------------------------------------------------------------
# Navigation Keybindings (FR-3, FR-4)
# ----------------------------------------------------------------------------
# These are handled by tmux-tilish, but we include explicit bindings

# Pane navigation with Alt+hjkl (FR-3)
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

# Move pane with Alt+Shift+hjkl (FR-4, FR-21)
bind -n M-S-h swap-pane -U
bind -n M-S-j swap-pane -D
bind -n M-S-k swap-pane -U
bind -n M-S-l swap-pane -D

# ----------------------------------------------------------------------------
# TPM Initialization
# ----------------------------------------------------------------------------
# Initialize TPM - must be at the end of the config file

run '~/.tmux/plugins/tpm/tpm'
