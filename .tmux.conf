# ============================================================================
# tmux-i3-workflow - i3wm-style tmux configuration
# Version: 1.0.0
# ============================================================================
# This configuration brings i3wm-style workflow to tmux, designed for i3wm
# users who want consistent keybindings across GUI and terminal.
# ============================================================================

# ----------------------------------------------------------------------------
# Core Settings (NFR-1, FR-17, FR-18, FR-19, NFR-7)
# ----------------------------------------------------------------------------

# Zero escape delay - critical for vim users (NFR-1)
set -s escape-time 0

# Windows and panes start at index 1 (FR-17, FR-18)
set -g base-index 1
setw -g pane-base-index 1

# Auto-renumber windows when one is closed (FR-19)
set -g renumber-windows on

# Enable mouse support for pane selection and resizing (NFR-7)
set -g mouse on

# Use vi mode for copy mode
setw -g mode-keys vi

# enable xterm keys like alt
setw -g xterm-keys on

# Enable extended keys for better modifier support
set -s extended-keys on

# Terminal color support - 256 colors + true color (NFR-4)
# UPDATE: kitty support
if-shell 'test -n "$KITTY_WINDOW_ID"' \
    'set -g default-terminal "xterm-kitty"' \
    'set -g default-terminal "xterm-256color"'

set -ag terminal-features "xterm*:sixel"
set -ag terminal-features "xterm*:RGB"
set -ag terminal-overrides "*:XT"
set -ag terminal-overrides "xterm*:Tc"
set -ag terminal-overrides 'xterm*:Tc:smglen@'
# set -sa terminal-overrides ',xterm-kitty:RGB'
# set -ga terminal-overrides ",xterm*:Tc:smcup@:rmcup@"
# set -ga terminal-overrides ",screen*:Tc:smcup@:rmcup@"
# set -ga terminal-overrides ",tmux*:Tc:smcup@:rmcup@"


# Increase history limit
set -g history-limit 50000

# Refresh status bar every 15 seconds (NFR-3)
set -g status-interval 15

# Enable focus events for vim autoread
set -g focus-events on

# Aggressive resize for shared sessions
setw -g aggressive-resize on

# ----------------------------------------------------------------------------
# Clipboard Integration - OSC 52 (FR-22, FR-23, FR-24)
# ----------------------------------------------------------------------------
# OSC 52 is a terminal escape sequence that enables clipboard access.
# Works in Kitty, Alacritty, iTerm2, Foot, and other modern terminals.

# Enable OSC 52 clipboard
set -g set-clipboard on

# Allow passthrough for SSH sessions (FR-24)
set -g allow-passthrough on

# Enable visual selection
set -g visual-activity on

# Vi-mode copy using OSC 52 (FR-22)
# The empty string tells tmux to use OSC 52
bind -T copy-mode-vi y send -X copy-pipe-and-cancel ""
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel ""
bind -T copy-mode-vi Enter send -X copy-pipe-and-cancel ""

# Vim-like visual selection
unbind-key -T copy-mode-vi v
bind -T copy-mode-vi d send -X clear-selection
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi V send -X select-line
bind -T copy-mode-vi C-v send -X rectangle-toggle

# Vim-like clipboard paste
unbind -T copy-mode-vi p
bind -T copy-mode-vi p paste-buffer \; send -X cancel

# Paste from system clipboard - Alt+p (FR-23)
bind -n M-p paste-buffer

# ----------------------------------------------------------------------------
# Plugin Manager (TPM)
# ----------------------------------------------------------------------------
# List of plugins to install with TPM

# TPM - Tmux Plugin Manager
set -g @plugin 'tmux-plugins/tpm'

set -g @plugin 'tmux-plugins/tmux-battery'
set -g @plugin 'tmux-plugins/tmux-cpu'

# Sensible defaults - base settings that everyone can agree on
set -g @plugin 'tmux-plugins/tmux-sensible'

# tmux-tilish - i3wm-style keybindings
set -g @plugin 'jabirali/tmux-tilish'

# tmux-sessionx - Fuzzy session management
set -g @plugin 'omerxx/tmux-sessionx'

# Catppuccin theme - beautiful colors (NFR-9)
set -g @plugin 'catppuccin/tmux'

# tmux-resurrect - Session persistence (FR-15)
set -g @plugin 'tmux-plugins/tmux-resurrect'

# tmux-continuum - Auto-save sessions (FR-16)
set -g @plugin 'tmux-plugins/tmux-continuum'

# tmux-better-mouse-mode - Better Mouse Scroll
set -g @plugin 'NHDaly/tmux-better-mouse-mode'
# ----------------------------------------------------------------------------
# Plugin Configuration: tmux-better-mouse-mode
# ----------------------------------------------------------------------------
set -g @scroll-in-moused-over-pane "on"
set -g @scroll-down-exit-copy-mode "on"
set -g @scroll-without-changing-pane "off"
set -g @scroll-speed-num-lines-per-scroll "3"
set -g @emulate-scroll-for-no-mouse-alternate-buffer "on"

# ----------------------------------------------------------------------------
# Plugin Configuration: tmux-tilish
# ----------------------------------------------------------------------------
# i3wm-style keybindings - no prefix mode

# Use Alt as modifier (like i3wm's $mod)
set -g @tilish-default "main-vertical"  # FR-20: Default layout
set -g @tilish-enforce ""

set -g @tilish-dmenu 'off'

# Don't use prefix mode - direct Alt bindings
set -g @tilish-noprefix "on"

# tmux-dotbar
# supposing you use catppuccin moccha
set -g @tmux-dotbar-bg "#1e1e2e"
set -g @tmux-dotbar-fg "#585b70"
set -g @tmux-dotbar-fg-current "#cdd6f4"
set -g @tmux-dotbar-fg-session "#9399b2"
set -g @tmux-dotbar-fg-prefix "#cba6f7"

# ----------------------------------------------------------------------------
# Plugin Configuration: tmux-sessionx
# ----------------------------------------------------------------------------
# Fuzzy session switcher

# Sessionx configuration for popup usage
set -g @sessionx-window-mode "on"
set -g @sessionx-zoxide-mode "on"
set -g @sessionx-preview-enabled "true"
set -g @sessionx-auto-accept "off"
set -g @sessionx-prefix "off"
set -g @sessionx-bind "M-f"

# ----------------------------------------------------------------------------
# Plugin Configuration: catppuccin (NFR-8, NFR-9)
# ----------------------------------------------------------------------------
# Minimal Catppuccin Mocha theme

set -g @catppuccin_flavor "mocha"
set -g @catppuccin_window_status_style "rounded"

# Status bar configuration
# set -g @catppuccin_status_left_separator ""
# set -g @catppuccin_status_right_separator " "
# set -g @catppuccin_status_fill "icon"
# set -g @catppuccin_status_connect_separator "no"
#
# # Window format
# set -g @catppuccin_window_default_fill "number"
# set -g @catppuccin_window_default_text "#W"
# set -g @catppuccin_window_current_fill "number"
# set -g @catppuccin_window_current_text "#W"

# Status modules
# set -g @catppuccin_status_modules_right "session"

set -g status-right-length 100
set -g status-left-length 100
set -g status-left ""
set -g status-right "#{E:@catppuccin_status_application}"
# set -agF status-right "#{E:@catppuccin_status_cpu}"
set -ag status-right "#{E:@catppuccin_status_session}"
# set -ag status-right "#{E:@catppuccin_status_uptime}"
# set -agF status-right "#{E:@catppuccin_status_battery}"

# ----------------------------------------------------------------------------
# Plugin Configuration: tmux-resurrect (FR-15)
# ----------------------------------------------------------------------------
# Session persistence and restoration

# Restore sessions on tmux start
set -g @resurrect-capture-pane-contents "on"
set -g @resurrect-strategy-nvim "session"

# Programs to restore
set -g @resurrect-processes 'vi vim nvim emacs man less head tail nvimpager top htop nvtop btm git lazygit yazi zellij'

# ----------------------------------------------------------------------------
# Plugin Configuration: tmux-continuum (FR-16)
# ----------------------------------------------------------------------------
# Auto-save sessions every 15 minutes

set -g @continuum-restore "on"
set -g @continuum-save-interval "15"

# ----------------------------------------------------------------------------
# Status Bar Configuration (NFR-8)
# ----------------------------------------------------------------------------
# Minimal status bar: Session | Windows | Time

# Status bar position
set -g status-position bottom

# # Status bar length
# set -g status-left-length 30
# set -g status-right-length 50
#
# # Left: session name
# set -g status-left "#S"
#
# # Center: window list
# set -g status-justify centre
#
# # Right: time
# set -g status-right "%H:%M"
#
# # Enable window activity monitoring
# set -g monitor-activity on
# setw -g monitor-activity on

# setw -g window-status-format '#W'
# setw -g window-status-current-format '#W'

# ----------------------------------------------------------------------------
# Custom Keybindings (FR-10 - Resize Mode)
# ----------------------------------------------------------------------------
# Additional bindings that supplement tmux-tilish

# Resize mode - Alt+r (FR-10)
# bind -n M-r switch-client -T resize
#
# # Resize mode key bindings
# bind -T resize h resize-pane -L 5
# bind -T resize j resize-pane -D 5
# bind -T resize k resize-pane -U 5
# bind -T resize l resize-pane -R 5
# bind -T resize H resize-pane -L 10
# bind -T resize J resize-pane -D 10
# bind -T resize K resize-pane -U 10
# bind -T resize L resize-pane -R 10
# bind -T resize Escape switch-client -T root
# bind -T resize Enter switch-client -T root

# Window switching with Alt+0-9 (supplemental - tilish handles 1-9)
# Note: tmux-tilish handles Alt+1 to Alt+9, we add Alt+0 for window 10
bind -n M-0 select-window -t 0

# Move pane to window with Alt+Shift+0-9 (FR-2)
# Note: tmux-tilish handles Alt+Shift+1 to Alt+Shift+9
# Move pane to window 10 (Alt+0 switches to window 10)
bind -n M-S-0 join-pane -t :10

# ----------------------------------------------------------------------------
# Popup Bindings (FR-25, FR-26)
# ----------------------------------------------------------------------------
# Centered popups for session switcher and zoxide

# Session switcher popup - Alt+f (FR-11, FR-25)
# bind -n M-f display-popup -E -w 80% -h 60% "tmux-sessionx"

# Zoxide directory picker popup - Alt+g (FR-13, FR-26)
bind -n M-g display-popup -E -w 80% -h 60% "~/.config/tmux/scripts/zoxide-jump.sh"
# bind -n M-f display-popup -E -w 80% -h 60% "~/.config/tmux/scripts/session-switcher.sh"
bind T display-popup -E -w 80% -h 60% "~/.config/tmux/scripts/zoxide-jump.sh"
bind t display-popup -E -w 80% -h 60% "~/.config/tmux/scripts/session-switcher.sh"

# Copy mode - Alt+q
bind -n M-q copy-mode

bind Enter copy-mode
# Exit copy mode with i or a (like entering Insert mode in vim)
bind -T copy-mode-vi i send -X cancel
bind -T copy-mode-vi a send -X cancel
bind -T copy-mode-vi q send -X cancel
bind -T copy-mode-vi Escape send -X cancel

# ----------------------------------------------------------------------------
# Split Keybindings (FR-5, FR-6, FR-7)
# ----------------------------------------------------------------------------
# These supplement tmux-tilish bindings

# Create new pane with Alt+Enter (FR-5)
# Note: tmux-tilish handles this, but we provide fallback
# bind -n M-Enter split-window -v -c "#{pane_current_path}"
bind -n M-\\ split-window -h -c "#{pane_current_path}"
bind -n M-- split-window -v -c "#{pane_current_path}"

bind -n M-Tab select-window -l
bind -n M-Space split-window -v -c "#{pane_current_path}" bash -c '$(echo -n $PATH | xargs -d : -I {} find {} -maxdepth 1 -executable -type f -printf "%P\\n" | sort -u | fzf)'

# Alt+s for main-horizontal layout (FR-6)
bind -n M-s select-layout main-horizontal

# Alt+v for main-vertical layout (FR-7)
bind -n M-S-v select-layout even-vertical

bind -n M-S-s select-layout even-horizontal

bind -n M-t select-layout tiled

# Alt+z for zoom (FR-8)
bind -n M-z resize-pane -Z

# Kill pane with confirmation - Alt+d (FR-9)
# bind -n M-d confirm-before -p "Kill pane #P? (y/n)" kill-pane
bind -n M-d kill-pane

# ----------------------------------------------------------------------------
# Navigation Keybindings (FR-3, FR-4)
# ----------------------------------------------------------------------------
# These are handled by tmux-tilish, but we include explicit bindings

# Pane navigation with Alt+hjkl (FR-3)
bind -n M-h select-pane -L
bind -n M-j select-pane -D
bind -n M-k select-pane -U
bind -n M-l select-pane -R

# Switch to last used session - Alt+i
bind -n M-i switch-client -l

# Move pane with Alt+Shift+hjkl (FR-4, FR-21)
bind -n M-S-h swap-pane -U
bind -n M-S-j swap-pane -D
bind -n M-S-k swap-pane -U
bind -n M-S-l swap-pane -D

# ----------------------------------------------------------------------------
# TPM Initialization
# ----------------------------------------------------------------------------
# Initialize TPM - must be at the end of the config file

# run-shell 'test -f ~/.tmux/plugins/tpm/tpm || git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm'

run '~/.tmux/plugins/tpm/tpm'
