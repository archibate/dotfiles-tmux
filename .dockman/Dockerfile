FROM ubuntu:latest

ARG HTTP_PROXY
ARG HTTPS_PROXY
ENV HTTP_PROXY=$HTTP_PROXY
ENV HTTPS_PROXY=$HTTPS_PROXY
ENV EDITOR=nvim
ENV OPENCODE_DISABLE_AUTOUPDATE=1
ENV OPENCODE_ENABLE_EXA=1

RUN sed -i s@/archive.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list && sed -i s@/security.ubuntu.com/@/mirrors.aliyun.com/@g /etc/apt/sources.list
RUN echo "Acquire::http::Proxy \"$HTTP_PROXY\";" >> /etc/apt/apt.conf && echo "Acquire::https::Proxy \"$HTTPS_PROXY\";" >> /etc/apt/apt.conf
RUN apt-get clean && apt-get update
RUN apt-get install -y curl
RUN apt-get install -y git
RUN apt-get install -y tmux
RUN apt-get install -y python3-dev python3-pip
RUN apt-get install -y nodejs npm
RUN apt-get install -y sudo
RUN apt-get install -y net-tools lsof
RUN apt-get install -y software-properties-common
RUN add-apt-repository ppa:neovim-ppa/unstable -y
RUN apt-get update
RUN apt-get install -y neovim
RUN apt-get install -y python-is-python3 python3-virtualenv
RUN apt-get install -y clickhouse-client

RUN passwd -d ubuntu && echo 'ubuntu ALL=(ALL) NOPASSWD:ALL' > /etc/sudoers.d/ubuntu-nopasswd && chmod 440 /etc/sudoers.d/ubuntu-nopasswd

USER ubuntu
RUN curl -fsSL https://opencode.ai/install | bash
ENV PATH="/home/ubuntu/.opencode/bin:$PATH"
RUN mkdir -p /home/ubuntu/.config/opencode /home/ubuntu/.local/share/opencode /home/ubuntu/.local/state/opencode /home/ubuntu/.cache/opencode

# {{{
RUN echo IyEvYmluL2Jhc2gKIyBHaXQgd3JhcHBlciBzY3JpcHQgdG8gcmVzdHJpY3QgYnJhbmNoIGFuZCB3b3JrdHJlZSBvcGVyYXRpb25zIGZvciBBSSBhZ2VudHMKIyBUaGlzIHNjcmlwdCBpbnRlcmNlcHRzIGdpdCBjYWxscyBhbmQgZGVuaWVzIGRhbmdlcm91cyBvcGVyYXRpb25zCgojICoqSU1QT1JUQU5UKioKIyBUSElTIElTIEEgU0VDVVJJVFkgV1JBUFBFUgojIERPIE5PVCBFRElUIFRISVMgRklMRQojIERPIE5PVCBUUlkgQllQQVNTIFRISVMgV1JBUFBFUgojIERPIE5PVCBJTlZPS0UgUkVBTCBHSVQgRElSRUNUTFkKCkRFTllfTUVTU0FHRT0ib3BlcmF0aW9uIGRlbmllZCBieSB1c2VyLCBwbGVhc2UgZG8gbm90IGV4ZWN1dGUgZ2l0IGJyYW5jaCBvcGVyYXRpb25zLiIKCiMgRmluZCB0aGUgcmVhbCBnaXQgYmluYXJ5ClJFQUxfR0lUPSIvdXNyL2Jpbi9naXQiCmlmIFtbICEgLXggIiRSRUFMX0dJVCIgXV07IHRoZW4KICAgIFJFQUxfR0lUPSIkKGNvbW1hbmQgLXYgZ2l0KSIKICAgIGlmIFtbIC16ICIkUkVBTF9HSVQiIF1dOyB0aGVuCiAgICAgICAgZWNobyAiRXJyb3I6IENhbm5vdCBmaW5kIHJlYWwgZ2l0IGJpbmFyeSIgPiYyCiAgICAgICAgZXhpdCAxCiAgICBmaQpmaQoKIyBHZXQgdGhlIGdpdCBzdWJjb21tYW5kCkdJVF9DTUQ9IiQxIgoKIyBGdW5jdGlvbiB0byBkZW55IG9wZXJhdGlvbgpkZW55KCkgewogICAgZWNobyAiJERFTllfTUVTU0FHRSIgPiYyCiAgICBleGl0IDEKfQoKaWYgW1sgLXogIiRPUEVOQ09ERSIgXV07IHRoZW4KICAgIGV4ZWMgIiRSRUFMX0dJVCIgIiRAIgpmaQoKIyBDaGVjayBmb3IgZGVuaWVkIG9wZXJhdGlvbnMKY2FzZSAiJDEiIGluCiAgICBicmFuY2gpCiAgICAgICAgIyBnaXQgYnJhbmNoIHdpdGggbm8gYXJndW1lbnRzIGxpc3RzIGJyYW5jaGVzIC0gQUxMT1cKICAgICAgICBpZiBbWyAkIyAtZXEgMSBdXTsgdGhlbgogICAgICAgICAgICBleGVjICIkUkVBTF9HSVQiICIkQCIKICAgICAgICBmaQoKICAgICAgICAjIENoZWNrIGZvciBkZWxldGUvZGVsZXRlLWZvcmNlL21vdmUvY29weSBmbGFncwogICAgICAgIGZvciBhcmcgaW4gIiR7QDoyfSI7IGRvCiAgICAgICAgICAgIGlmIFtbICIkYXJnIiA9PSAiLWQiIHx8ICIkYXJnIiA9PSAiLUQiIHx8ICIkYXJnIiA9PSAiLS1kZWxldGUiIF1dOyB0aGVuCiAgICAgICAgICAgICAgICBkZW55CiAgICAgICAgICAgIGZpCiAgICAgICAgICAgIGlmIFtbICIkYXJnIiA9PSAiLW0iIHx8ICIkYXJnIiA9PSAiLU0iIHx8ICIkYXJnIiA9PSAiLS1tb3ZlIiBdXTsgdGhlbgogICAgICAgICAgICAgICAgZGVueQogICAgICAgICAgICBmaQogICAgICAgICAgICBpZiBbWyAiJGFyZyIgPT0gIi1jIiB8fCAiJGFyZyIgPT0gIi1DIiB8fCAiJGFyZyIgPT0gIi0tY29weSIgXV07IHRoZW4KICAgICAgICAgICAgICAgIGRlbnkKICAgICAgICAgICAgZmkKICAgICAgICBkb25lCgogICAgICAgICMgZ2l0IGJyYW5jaCA8bmV3LW5hbWU+IGNyZWF0ZXMgYSBicmFuY2ggLSBERU5ZCiAgICAgICAgIyAodW5sZXNzIGl0J3MganVzdCBsaXN0aW5nIHdpdGggZmxhZ3MgbGlrZSAtdiwgLWEsIGV0Yy4pCiAgICAgICAgZm9yIGFyZyBpbiAiJHtAOjJ9IjsgZG8KICAgICAgICAgICAgaWYgW1sgIiRhcmciID09ICItIiogXV07IHRoZW4KICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIGZpCiAgICAgICAgICAgICMgTm9uLWZsYWcgYXJndW1lbnQgbWVhbnMgY3JlYXRpbmcgYSBuZXcgYnJhbmNoCiAgICAgICAgICAgIGRlbnkKICAgICAgICBkb25lCgogICAgICAgICMgSWYgd2UgZ2V0IGhlcmUsIGl0J3MgYSBsaXN0IG9wZXJhdGlvbiB3aXRoIGZsYWdzCiAgICAgICAgZXhlYyAiJFJFQUxfR0lUIiAiJEAiCiAgICAgICAgOzsKCiAgICBjaGVja291dCkKICAgICAgICAjIGdpdCBjaGVja291dCAtYiA8YnJhbmNoPiBjcmVhdGVzIGFuZCBzd2l0Y2hlcyB0byBuZXcgYnJhbmNoIC0gREVOWQogICAgICAgIGlmIFtbICIkMiIgPT0gIi1iIiB8fCAiJDIiID09ICItQiIgXV07IHRoZW4KICAgICAgICAgICAgZGVueQogICAgICAgIGZpCgogICAgICAgICMgZ2l0IGNoZWNrb3V0IC0tb3JwaGFuIDxicmFuY2g+IGNyZWF0ZXMgb3JwaGFuIGJyYW5jaCAtIERFTlkKICAgICAgICBmb3IgYXJnIGluICIke0A6Mn0iOyBkbwogICAgICAgICAgICBpZiBbWyAiJGFyZyIgPT0gIi0tb3JwaGFuIiBdXTsgdGhlbgogICAgICAgICAgICAgICAgZGVueQogICAgICAgICAgICBmaQogICAgICAgIGRvbmUKCiAgICAgICAgIyBnaXQgY2hlY2tvdXQgLXQvLS10cmFjayBjYW4gY3JlYXRlIG5ldyB0cmFja2luZyBicmFuY2ggLSBERU5ZCiAgICAgICAgZm9yIGFyZyBpbiAiJHtAOjJ9IjsgZG8KICAgICAgICAgICAgaWYgW1sgIiRhcmciID09ICItdCIgfHwgIiRhcmciID09ICItLXRyYWNrIiBdXTsgdGhlbgogICAgICAgICAgICAgICAgZGVueQogICAgICAgICAgICBmaQogICAgICAgIGRvbmUKCiAgICAgICAgIyBnaXQgY2hlY2tvdXQgPGJyYW5jaD4gc3dpdGNoZXMgYnJhbmNoIC0gREVOWQogICAgICAgICMgQnV0IGdpdCBjaGVja291dCAtLSA8ZmlsZT4gcmVzdG9yZXMgZmlsZXMgLSBBTExPVwogICAgICAgIGlmIFtbICQjIC1ndCAxICYmICIkMiIgIT0gIi0tIiBdXTsgdGhlbgogICAgICAgICAgICAjIENoZWNrIGlmIHNlY29uZCBhcmd1bWVudCBsb29rcyBsaWtlIGEgYnJhbmNoIChub3QgYSBmaWxlKQogICAgICAgICAgICAjIEJyYW5jaGVzIGRvbid0IHR5cGljYWxseSBoYXZlIHNsYXNoZXMgdW5sZXNzIHRoZXkncmUgbmFtZXNwYWNlZCwKICAgICAgICAgICAgIyBhbmQgcGF0aHMgdXN1YWxseSBoYXZlIC4gb3IgLyBhcyBzZXBhcmF0b3IKICAgICAgICAgICAgaWYgW1sgIiQyIiAhPSAiLSIqICYmICIkMiIgIT0gKi4qIF1dOyB0aGVuCiAgICAgICAgICAgICAgICBkZW55CiAgICAgICAgICAgIGZpCiAgICAgICAgZmkKCiAgICAgICAgIyBBbGxvdyBmaWxlIGNoZWNrb3V0IG9wZXJhdGlvbnMKICAgICAgICBleGVjICIkUkVBTF9HSVQiICIkQCIKICAgICAgICA7OwoKICAgIHN3aXRjaCkKICAgICAgICAjIGdpdCBzd2l0Y2ggLWMgPGJyYW5jaD4gY3JlYXRlcyBhbmQgc3dpdGNoZXMgLSBERU5ZCiAgICAgICAgaWYgW1sgIiQyIiA9PSAiLWMiIHx8ICIkMiIgPT0gIi1DIiBdXTsgdGhlbgogICAgICAgICAgICBkZW55CiAgICAgICAgZmkKCiAgICAgICAgIyBnaXQgc3dpdGNoIC0tb3JwaGFuIDxicmFuY2g+IGNyZWF0ZXMgb3JwaGFuIGJyYW5jaCAtIERFTlkKICAgICAgICBmb3IgYXJnIGluICIke0A6Mn0iOyBkbwogICAgICAgICAgICBpZiBbWyAiJGFyZyIgPT0gIi0tb3JwaGFuIiBdXTsgdGhlbgogICAgICAgICAgICAgICAgZGVueQogICAgICAgICAgICBmaQogICAgICAgIGRvbmUKCiAgICAgICAgIyBnaXQgc3dpdGNoIC10Ly0tdHJhY2sgY2FuIGNyZWF0ZSBuZXcgdHJhY2tpbmcgYnJhbmNoIC0gREVOWQogICAgICAgIGZvciBhcmcgaW4gIiR7QDoyfSI7IGRvCiAgICAgICAgICAgIGlmIFtbICIkYXJnIiA9PSAiLXQiIHx8ICIkYXJnIiA9PSAiLS10cmFjayIgXV07IHRoZW4KICAgICAgICAgICAgICAgIGRlbnkKICAgICAgICAgICAgZmkKICAgICAgICBkb25lCgogICAgICAgICMgZ2l0IHN3aXRjaCA8YnJhbmNoPiBzd2l0Y2hlcyBicmFuY2ggLSBERU5ZCiAgICAgICAgaWYgW1sgJCMgLWd0IDEgJiYgIiQyIiAhPSAiLSIqIF1dOyB0aGVuCiAgICAgICAgICAgIGRlbnkKICAgICAgICBmaQoKICAgICAgICAjIEFsbG93IG90aGVyIHN3aXRjaCBvcGVyYXRpb25zIChpZiBhbnkpCiAgICAgICAgZXhlYyAiJFJFQUxfR0lUIiAiJEAiCiAgICAgICAgOzsKCiAgICB3b3JrdHJlZSkKICAgICAgICAjIEJsb2NrIGFsbCB3b3JrdHJlZSBvcGVyYXRpb25zCiAgICAgICAgZGVueQogICAgICAgIDs7CgogICAgdXBkYXRlLXJlZikKICAgICAgICAjIEJsb2NrIGxvdy1sZXZlbCByZWYgbWFuaXB1bGF0aW9uIChjYW4gY3JlYXRlL2RlbGV0ZS9tb2RpZnkgYnJhbmNoZXMpCiAgICAgICAgZGVueQogICAgICAgIDs7CgogICAgc3ltYm9saWMtcmVmKQogICAgICAgICMgQmxvY2sgc3ltYm9saWMgcmVmIG1hbmlwdWxhdGlvbiAoY2FuIGNoYW5nZSBIRUFEL2JyYW5jaCkKICAgICAgICBkZW55CiAgICAgICAgOzsKCiAgICBwdXNoKQogICAgICAgICMgQmxvY2sgcHVzaCBvcGVyYXRpb25zCiAgICAgICAgZGVueQogICAgICAgIDs7CgogICAgcHVsbCkKICAgICAgICAjIEJsb2NrIHB1bGwgb3BlcmF0aW9ucwogICAgICAgIGRlbnkKICAgICAgICA7OwoKICAgIGZldGNoKQogICAgICAgICMgQmxvY2sgZmV0Y2ggb3BlcmF0aW9ucwogICAgICAgIGRlbnkKICAgICAgICA7OwoKICAgIHJlbW90ZSkKICAgICAgICAjIEJsb2NrIGFsbCByZW1vdGUgb3BlcmF0aW9ucyAoYWRkLCByZW1vdmUsIHJlbmFtZSwgdXBkYXRlLCBldGMuKQogICAgICAgIGRlbnkKICAgICAgICA7OwoKICAgIGNsb25lKQogICAgICAgICMgQmxvY2sgY2xvbmUgb3BlcmF0aW9ucwogICAgICAgIGRlbnkKICAgICAgICA7OwoKICAgIGNvbmZpZykKICAgICAgICAjIEJsb2NrIGNvbmZpZyBvcGVyYXRpb25zCiAgICAgICAgZGVueQogICAgICAgIDs7CgogICAgdGFnKQogICAgICAgICMgQmxvY2sgYWxsIHRhZyBvcGVyYXRpb25zIChjcmVhdGUsIGRlbGV0ZSwgdmVyaWZ5KQogICAgICAgIGRlbnkKICAgICAgICA7OwoKICAgIHBydW5lKQogICAgICAgICMgQmxvY2sgcHJ1bmUgb3BlcmF0aW9ucyAocmVtb3ZlcyB1bnJlYWNoYWJsZSBvYmplY3RzKQogICAgICAgIGRlbnkKICAgICAgICA7OwoKICAgIGdjKQogICAgICAgICMgQmxvY2sgZ2FyYmFnZSBjb2xsZWN0aW9uIChjYW4gY2hhbmdlIHJlcG9zaXRvcnkgc3RhdGUpCiAgICAgICAgZGVueQogICAgICAgIDs7CgogICAgZmFzdC1pbXBvcnQpCiAgICAgICAgIyBCbG9jayBmYXN0LWltcG9ydCAobG93LWxldmVsIGRhdGEgaW1wb3J0LCBjYW4gY3JlYXRlIHJlZnMpCiAgICAgICAgZGVueQogICAgICAgIDs7CgogICAgY29tbWl0LXRyZWUpCiAgICAgICAgIyBCbG9jayBsb3ctbGV2ZWwgY29tbWl0IGNyZWF0aW9uIChieXBhc3NlcyBub3JtYWwgY2hlY2tzKQogICAgICAgIGRlbnkKICAgICAgICA7OwoKICAgIHJlcGxhY2UpCiAgICAgICAgIyBCbG9jayByZXBsYWNlIG9wZXJhdGlvbnMgKGNhbiBhbHRlciBoaXN0b3J5L3JlZnMpCiAgICAgICAgZGVueQogICAgICAgIDs7CgogICAgKikKICAgICAgICAjIEFsbG93IGFsbCBvdGhlciBnaXQgY29tbWFuZHMKICAgICAgICBleGVjICIkUkVBTF9HSVQiICIkQCIKICAgICAgICA7Owplc2FjCg== | base64 -d > /home/ubuntu/.opencode/bin/git && chmod +x /home/ubuntu/.opencode/bin/git
# }}}
CMD /bin/bash
